<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLS Politikalarƒ±nƒ± D√ºzelt</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            text-align: center;
            margin-bottom: 30px;
        }
        .sql-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .sql-code {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .instructions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning {
            background: #fee2e2;
            border: 1px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #dcfce7;
            border: 1px solid #22c55e;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .copy-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 0;
        }
        .copy-btn:hover {
            background: #1d4ed8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß RLS Politikalarƒ±nƒ± D√ºzelt</h1>
        
        <div class="instructions">
            <h3>üìã Talimatlar:</h3>
            <ol>
                <li>Supabase Dashboard'a gidin</li>
                <li>SQL Editor'√º a√ßƒ±n</li>
                <li>A≈üaƒüƒ±daki SQL kodunu kopyalayƒ±n</li>
                <li>SQL Editor'e yapƒ±≈ütƒ±rƒ±n ve √ßalƒ±≈ütƒ±rƒ±n</li>
                <li>Sonu√ßlarƒ± kontrol edin</li>
            </ol>
        </div>

        <div class="warning">
            <h3>‚ö†Ô∏è √ñnemli Not:</h3>
            <p>Bu SQL kodu t√ºm mevcut RLS politikalarƒ±nƒ± silip yeniden olu≈üturacaktƒ±r. Bu i≈ülem g√ºvenlidir ve performans sorunlarƒ±nƒ± √ß√∂zecektir.</p>
        </div>

        <button class="copy-btn" onclick="copySQL()">üìã SQL Kodunu Kopyala</button>
        
        <div class="sql-container">
            <div class="sql-code" id="sqlCode">-- RLS politikalarƒ±nƒ± d√ºzelt - auth.uid() performans sorunlarƒ±nƒ± √ß√∂z
-- Bu migration t√ºm √ßakƒ±≈üan politikalarƒ± temizler ve optimize edilmi≈ü versiyonlarƒ±nƒ± olu≈üturur

-- 1. Birds tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own birds" ON public.birds;
DROP POLICY IF EXISTS "Users can create their own birds" ON public.birds;
DROP POLICY IF EXISTS "Users can update their own birds" ON public.birds;
DROP POLICY IF EXISTS "Users can delete their own birds" ON public.birds;
DROP POLICY IF EXISTS "Users can manage their own birds" ON public.birds;

-- Optimize edilmi≈ü tek policy olu≈ütur
CREATE POLICY "Users can manage their own birds" 
ON public.birds 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 2. Chicks tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own chicks" ON public.chicks;
DROP POLICY IF EXISTS "Users can create their own chicks" ON public.chicks;
DROP POLICY IF EXISTS "Users can update their own chicks" ON public.chicks;
DROP POLICY IF EXISTS "Users can delete their own chicks" ON public.chicks;
DROP POLICY IF EXISTS "Users can manage their own chicks" ON public.chicks;

CREATE POLICY "Users can manage their own chicks" 
ON public.chicks 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 3. Eggs tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own eggs" ON public.eggs;
DROP POLICY IF EXISTS "Users can create their own eggs" ON public.eggs;
DROP POLICY IF EXISTS "Users can update their own eggs" ON public.eggs;
DROP POLICY IF EXISTS "Users can delete their own eggs" ON public.eggs;
DROP POLICY IF EXISTS "Users can manage their own eggs" ON public.eggs;

CREATE POLICY "Users can manage their own eggs" 
ON public.eggs 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 4. Incubations tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own incubations" ON public.incubations;
DROP POLICY IF EXISTS "Users can create their own incubations" ON public.incubations;
DROP POLICY IF EXISTS "Users can update their own incubations" ON public.incubations;
DROP POLICY IF EXISTS "Users can delete their own incubations" ON public.incubations;
DROP POLICY IF EXISTS "Users can manage their own incubations" ON public.incubations;

CREATE POLICY "Users can manage their own incubations" 
ON public.incubations 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 5. Clutches tablosu i√ßin politikalarƒ± d√ºzelt (eƒüer varsa)
DROP POLICY IF EXISTS "Users can view their own clutches" ON public.clutches;
DROP POLICY IF EXISTS "Users can create their own clutches" ON public.clutches;
DROP POLICY IF EXISTS "Users can update their own clutches" ON public.clutches;
DROP POLICY IF EXISTS "Users can delete their own clutches" ON public.clutches;

CREATE POLICY "Users can manage their own clutches" 
ON public.clutches 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 6. Calendar tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own calendar" ON public.calendar;
DROP POLICY IF EXISTS "Users can view their own calendar events" ON public.calendar;
DROP POLICY IF EXISTS "Users can create their own calendar" ON public.calendar;
DROP POLICY IF EXISTS "Users can create their own calendar events" ON public.calendar;
DROP POLICY IF EXISTS "Users can update their own calendar" ON public.calendar;
DROP POLICY IF EXISTS "Users can update their own calendar events" ON public.calendar;
DROP POLICY IF EXISTS "Users can delete their own calendar" ON public.calendar;
DROP POLICY IF EXISTS "Users can delete their own calendar events" ON public.calendar;

CREATE POLICY "Users can manage their own calendar events" 
ON public.calendar 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 7. Backup tablolarƒ± i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own backup jobs" ON public.backup_jobs;
DROP POLICY IF EXISTS "Users can create their own backup jobs" ON public.backup_jobs;
DROP POLICY IF EXISTS "Users can update their own backup jobs" ON public.backup_jobs;

CREATE POLICY "Users can manage their own backup jobs" 
ON public.backup_jobs 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

DROP POLICY IF EXISTS "Users can view their own backup settings" ON public.backup_settings;
DROP POLICY IF EXISTS "Users can create their own backup settings" ON public.backup_settings;
DROP POLICY IF EXISTS "Users can update their own backup settings" ON public.backup_settings;

CREATE POLICY "Users can manage their own backup settings" 
ON public.backup_settings 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

DROP POLICY IF EXISTS "Users can view their own backup history" ON public.backup_history;

CREATE POLICY "Users can view their own backup history" 
ON public.backup_history 
FOR SELECT 
USING ((SELECT auth.uid()) = user_id);

-- 8. Notification tablolarƒ± i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can manage their own notification tokens" ON public.user_notification_tokens;
DROP POLICY IF EXISTS "Users can manage their own notification settings" ON public.user_notification_settings;
DROP POLICY IF EXISTS "Users can manage their own notification interactions" ON public.notification_interactions;

CREATE POLICY "Users can manage their own notification tokens" 
ON public.user_notification_tokens 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

CREATE POLICY "Users can manage their own notification settings" 
ON public.user_notification_settings 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

CREATE POLICY "Users can manage their own notification interactions" 
ON public.notification_interactions 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 9. Profiles tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can update their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can insert their own profile" ON public.profiles;

CREATE POLICY "Users can manage their own profile" 
ON public.profiles 
FOR ALL 
USING ((SELECT auth.uid()) = id);

-- 10. Photos tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own photos" ON public.photos;
DROP POLICY IF EXISTS "Users can insert their own photos" ON public.photos;
DROP POLICY IF EXISTS "Users can update their own photos" ON public.photos;
DROP POLICY IF EXISTS "Users can delete their own photos" ON public.photos;

CREATE POLICY "Users can manage their own photos" 
ON public.photos 
FOR ALL 
USING ((SELECT auth.uid()) = user_id);

-- 11. Feedback tablosu i√ßin politikalarƒ± d√ºzelt
DROP POLICY IF EXISTS "Users can view their own feedback" ON public.feedback;
DROP POLICY IF EXISTS "Users can insert feedback" ON public.feedback;
DROP POLICY IF EXISTS "Users can update their own feedback" ON public.feedback;

CREATE POLICY "Users can view their own feedback" 
ON public.feedback 
FOR SELECT 
USING ((SELECT auth.uid()) = user_id);

CREATE POLICY "Users can insert feedback" 
ON public.feedback 
FOR INSERT 
WITH CHECK (true);

CREATE POLICY "Users can update their own feedback" 
ON public.feedback 
FOR UPDATE 
USING ((SELECT auth.uid()) = user_id);

-- 12. Tablo istatistiklerini g√ºncelle
ANALYZE public.birds;
ANALYZE public.chicks;
ANALYZE public.eggs;
ANALYZE public.incubations;
ANALYZE public.clutches;
ANALYZE public.calendar;
ANALYZE public.backup_jobs;
ANALYZE public.backup_settings;
ANALYZE public.backup_history;
ANALYZE public.user_notification_tokens;
ANALYZE public.user_notification_settings;
ANALYZE public.notification_interactions;
ANALYZE public.profiles;
ANALYZE public.photos;
ANALYZE public.feedback;

-- 13. RLS'nin aktif olduƒüundan emin ol
ALTER TABLE public.birds ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chicks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.eggs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.incubations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.clutches ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.calendar ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.backup_jobs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.backup_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.backup_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_notification_tokens ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_notification_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notification_interactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.photos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.feedback ENABLE ROW LEVEL SECURITY;</div>
        </div>

        <div class="success">
            <h3>‚úÖ Bu SQL kodu ≈üunlarƒ± yapacak:</h3>
            <ul>
                <li>T√ºm √ßakƒ±≈üan RLS politikalarƒ±nƒ± temizler</li>
                <li>Optimize edilmi≈ü tek politikalar olu≈üturur</li>
                <li>auth.uid() performans sorunlarƒ±nƒ± √ß√∂zer</li>
                <li>Tablo istatistiklerini g√ºnceller</li>
                <li>RLS'nin aktif olduƒüundan emin olur</li>
            </ul>
        </div>

        <div class="instructions">
            <h3>üîç Sonu√ßlarƒ± Kontrol Etmek ƒ∞√ßin:</h3>
            <p>A≈üaƒüƒ±daki SQL sorgusunu √ßalƒ±≈ütƒ±rarak politikalarƒ±n doƒüru olu≈üturulduƒüunu kontrol edebilirsiniz:</p>
            <div class="sql-container">
                <div class="sql-code">SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies 
WHERE schemaname = 'public' 
ORDER BY tablename, policyname;</div>
            </div>
        </div>
    </div>

    <script>
        function copySQL() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(function() {
                alert('SQL kodu panoya kopyalandƒ±!');
            }).catch(function(err) {
                console.error('Kopyalama ba≈üarƒ±sƒ±z:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = sqlCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('SQL kodu panoya kopyalandƒ±!');
            });
        }
    </script>
</body>
</html> 